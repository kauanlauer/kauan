<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KauanWin XP | Portfólio Interativo</title>
  <style>
    :root {
      --xp-taskbar: linear-gradient(to bottom, #4ea0f7 0%, #2f79df 45%, #1b5ec8 80%, #1b56b5 100%);
      --xp-start: linear-gradient(to bottom, #66d957 0%, #35b448 55%, #2a9a3c 100%);
      --xp-window: #ece9d8;
      --xp-title: linear-gradient(to bottom, #1f7adf 0%, #0a4ea6 100%);
      --xp-title-inactive: linear-gradient(to bottom, #7e92af 0%, #5f738e 100%);
      --xp-border: #2456a8;
      --shadow: 0 12px 26px rgba(0, 0, 0, 0.5);
      --desktop-text: #ffffff;
      --icon-w: 86px;
      --icon-h: 92px;
      --grid-x: 94px;
      --grid-y: 96px;
      --desk-padding-x: 12px;
      --desk-padding-y: 12px;
    }

    * {
      box-sizing: border-box;
      user-select: none;
      -webkit-user-drag: none;
    }

    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: Tahoma, Verdana, Segoe UI, sans-serif;
      font-size: 13px;
    }

    body { background: #2454a8; color: #111; }

    .desktop {
      position: fixed;
      inset: 0 0 32px 0;
      background-image: url('https://upload.wikimedia.org/wikipedia/en/5/5f/Bliss_%28Windows_XP%29.png');
      background-size: cover;
      background-position: center;
      overflow: hidden;
      isolation: isolate;
    }

    .desktop::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 25% 18%, rgba(255,255,255,0.11), transparent 45%);
      pointer-events: none;
      z-index: -1;
    }

    .desktop-icons {
      position: absolute;
      inset: 0;
      pointer-events: auto;
    }

    .desktop-icon {
      position: absolute;
      width: var(--icon-w);
      height: var(--icon-h);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 5px;
      border: 1px solid transparent;
      border-radius: 4px;
      padding: 4px 2px;
      cursor: default;
      transition: transform 0.14s ease;
    }

    .desktop-icon.dragging { transform: scale(1.03); }

    .desktop-icon.selected {
      border-color: rgba(255,255,255,0.45);
      background: rgba(25, 70, 150, 0.36);
    }

    .desktop-icon img {
      width: 40px;
      height: 40px;
      object-fit: contain;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.55));
      pointer-events: none;
    }

    .desktop-icon span {
      max-width: 78px;
      font-size: 12px;
      color: var(--desktop-text);
      text-align: center;
      text-shadow: 0 1px 2px rgba(0,0,0,0.9);
      line-height: 1.15;
      padding: 1px 2px;
      border-radius: 2px;
      pointer-events: none;
    }

    .selection-box {
      position: absolute;
      border: 1px dashed #e7f1ff;
      background: rgba(94, 162, 255, 0.28);
      display: none;
      pointer-events: none;
      z-index: 5;
    }

    .window-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .xp-window {
      position: absolute;
      width: 620px;
      min-width: 300px;
      min-height: 220px;
      background: var(--xp-window);
      border: 1px solid var(--xp-border);
      border-radius: 7px 7px 5px 5px;
      box-shadow: var(--shadow);
      overflow: hidden;
      pointer-events: auto;
      transform-origin: center center;
    }

    .xp-window.inactive .titlebar { background: var(--xp-title-inactive); }

    .xp-window.maximized {
      width: 100% !important;
      height: calc(100% - 32px) !important;
      top: 0 !important;
      left: 0 !important;
      border-radius: 0;
      border-left: 0;
      border-right: 0;
    }

    .xp-window.minimizing {
      animation: winMin .16s ease forwards;
    }

    .xp-window.restoring {
      animation: winRestore .18s ease;
    }

    @keyframes winMin {
      to { transform: scale(.86); opacity: 0; }
    }

    @keyframes winRestore {
      from { transform: scale(.93); opacity: .25; }
      to { transform: scale(1); opacity: 1; }
    }

    .titlebar {
      height: 30px;
      background: var(--xp-title);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 4px 0 8px;
      cursor: move;
      border-bottom: 1px solid #17407f;
      gap: 8px;
    }

    .title-info {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
    }

    .title-info img { width: 16px; height: 16px; object-fit: contain; }

    .title-info span {
      font-weight: 700;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .window-controls { display: flex; gap: 4px; }

    .win-btn {
      width: 23px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.75);
      background: linear-gradient(to bottom, #7eb7f7, #3f87dd);
      color: #fff;
      font-size: 12px;
      font-weight: 700;
      line-height: 1;
      display: grid;
      place-items: center;
      cursor: pointer;
      padding: 0;
    }

    .win-btn:active { transform: translateY(1px); }

    .win-btn.close {
      background: linear-gradient(to bottom, #ff856d, #db3d1f);
      border-color: rgba(255,220,220,0.9);
    }

    .window-body {
      height: calc(100% - 30px);
      overflow: auto;
      background: linear-gradient(to bottom, #fffdf7, #ece8d5);
      padding: 14px;
    }

    .window-section {
      background: #fff;
      border: 1px solid #b9c7e0;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .window-section h3 { margin: 0 0 6px; color: #174489; font-size: 16px; }
    .window-section p, .window-section li { margin: 0; line-height: 1.45; }
    .window-section ul { padding-left: 18px; margin: 0; }

    .skills-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .skill-pill {
      border: 1px solid #b4c3de;
      border-radius: 4px;
      background: #f2f6fd;
      padding: 8px;
      font-weight: 600;
    }

    .status-bar {
      margin-top: 10px;
      border: 1px solid #b8c7df;
      background: #f2f7ff;
      border-radius: 4px;
      padding: 6px 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
      color: #335;
    }

    .taskbar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 32px;
      background: var(--xp-taskbar);
      border-top: 1px solid #7fb3ff;
      display: flex;
      align-items: stretch;
      z-index: 9999;
    }

    .start-button {
      min-width: 96px;
      max-width: 130px;
      border: 0;
      border-right: 1px solid rgba(0,0,0,0.2);
      color: #fff;
      font-weight: 700;
      font-style: italic;
      font-size: 15px;
      background: var(--xp-start);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      cursor: pointer;
      text-shadow: 0 1px 1px rgba(0,0,0,0.45);
      border-radius: 0 8px 8px 0;
      padding-inline: 10px;
    }

    .start-button .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 0 6px rgba(255,255,255,0.8);
    }

    .task-buttons {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 3px;
      padding: 3px 4px;
      overflow-x: auto;
      scrollbar-width: thin;
    }

    .task-btn {
      height: 25px;
      min-width: 142px;
      max-width: 240px;
      border: 1px solid #174087;
      border-radius: 4px;
      background: linear-gradient(to bottom, #6daaf3, #3f87de);
      color: #fff;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 0 8px;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .task-btn.active {
      background: linear-gradient(to bottom, #9ec7fb, #5a9bed);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.45);
    }

    .task-btn img { width: 14px; height: 14px; object-fit: contain; }

    .tray {
      min-width: 102px;
      border-left: 1px solid rgba(0,0,0,0.25);
      background: linear-gradient(to bottom, #4795eb, #2f73d1);
      color: #fff;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 0 8px;
      text-shadow: 0 1px 1px rgba(0,0,0,0.45);
    }

    .start-menu {
      position: fixed;
      left: 2px;
      bottom: 34px;
      width: 338px;
      height: 430px;
      border-radius: 7px 7px 0 0;
      overflow: hidden;
      border: 1px solid #1a3f7f;
      box-shadow: 0 14px 30px rgba(0,0,0,0.5);
      display: none;
      z-index: 10000;
      background: #fff;
    }

    .start-menu.open { display: block; }

    .start-top {
      height: 78px;
      background: linear-gradient(to bottom, #2f80dc, #195dbd);
      color: #fff;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .start-top img {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.65);
      object-fit: cover;
    }

    .start-top strong { display: block; font-size: 15px; }

    .start-body {
      display: grid;
      grid-template-columns: 1fr 120px;
      height: calc(100% - 78px);
    }

    .start-apps { background: #fff; padding: 8px; overflow: auto; }

    .start-item {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      border: 0;
      background: transparent;
      text-align: left;
      border-radius: 5px;
      padding: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    .start-item:hover { background: #dbe8ff; }
    .start-item img { width: 24px; height: 24px; object-fit: contain; }

    .start-side {
      background: linear-gradient(to bottom, #d9e9ff, #b4d1f8);
      border-left: 1px solid #97b8e9;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .start-side button,
    .start-side a {
      border: 1px solid #7f9fcc;
      background: #f4f8ff;
      border-radius: 4px;
      padding: 5px;
      font-size: 12px;
      text-decoration: none;
      color: #123;
      text-align: center;
      cursor: pointer;
    }

    .desktop-menu {
      position: fixed;
      min-width: 190px;
      border: 1px solid #7b95c0;
      background: #f5f7fc;
      box-shadow: 0 12px 20px rgba(0,0,0,0.3);
      display: none;
      z-index: 10010;
      font-size: 13px;
      padding: 3px;
    }

    .desktop-menu.open { display: block; }

    .desktop-menu button {
      width: 100%;
      border: 0;
      background: transparent;
      text-align: left;
      padding: 6px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 13px;
    }

    .desktop-menu button:hover { background: #316ac5; color: #fff; }
    .desktop-menu hr { border: 0; border-top: 1px solid #b9c9e4; margin: 3px 0; }

    .toast {
      position: fixed;
      right: 14px;
      bottom: 46px;
      background: rgba(20, 43, 81, 0.94);
      color: #fff;
      border: 1px solid rgba(173, 203, 255, 0.55);
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 12px;
      display: none;
      z-index: 10020;
    }

    .toast.show { display: block; animation: fade 2.2s ease forwards; }

    @keyframes fade {
      0% { opacity: 0; transform: translateY(10px); }
      15%, 80% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(4px); }
    }

    @media (max-width: 900px) {
      :root {
        --icon-w: 78px;
        --icon-h: 88px;
        --grid-x: 84px;
        --grid-y: 92px;
      }

      .start-menu {
        width: calc(100vw - 8px);
        height: 56vh;
      }

      .task-btn { min-width: 120px; }
      .xp-window { width: 94vw; }
    }
  </style>
</head>
<body>
  <div class="desktop" id="desktop">
    <div class="desktop-icons" id="desktopIcons"></div>
    <div class="selection-box" id="selectionBox"></div>
    <div class="window-layer" id="windowLayer"></div>
  </div>

  <div class="start-menu" id="startMenu">
    <div class="start-top">
      <img src="https://i.postimg.cc/KYyJYJjM/eu2.jpg" alt="Kauan">
      <div>
        <strong>Kauan Lauer</strong>
        <span>Técnico de TI • Headsoft</span>
      </div>
    </div>
    <div class="start-body">
      <div class="start-apps" id="startApps"></div>
      <div class="start-side">
        <button data-action="about">Meu Perfil</button>
        <button data-action="skills">Competências</button>
        <button data-action="experience">Experiência</button>
        <button data-action="contact">Contato</button>
        <button data-action="pocket">Pocket OS</button>
        <button data-action="portfolio">Portfólio Web</button>
        <a href="https://kauanlauer.com.br/curriculo" target="_blank" rel="noopener">Currículo</a>
      </div>
    </div>
  </div>

  <div class="desktop-menu" id="desktopMenu">
    <button data-cmd="refresh">Atualizar</button>
    <button data-cmd="arrange">Organizar Ícones</button>
    <hr>
    <button data-cmd="about">Sobre o KauanWin</button>
    <button data-cmd="properties">Propriedades</button>
  </div>

  <div class="toast" id="toast"></div>

  <div class="taskbar">
    <button class="start-button" id="startButton">
      <span class="dot"></span>
      <span>start</span>
    </button>
    <div class="task-buttons" id="taskButtons"></div>
    <div class="tray"><span id="clock">00:00</span></div>
  </div>

  <template id="windowTemplate">
    <article class="xp-window">
      <div class="titlebar">
        <div class="title-info">
          <img alt="Ícone">
          <span></span>
        </div>
        <div class="window-controls">
          <button class="win-btn min" title="Minimizar">_</button>
          <button class="win-btn max" title="Maximizar">□</button>
          <button class="win-btn close" title="Fechar">×</button>
        </div>
      </div>
      <div class="window-body"></div>
    </article>
  </template>

  <script>
    const desktop = document.getElementById('desktop');
    const desktopIcons = document.getElementById('desktopIcons');
    const windowLayer = document.getElementById('windowLayer');
    const taskButtons = document.getElementById('taskButtons');
    const startButton = document.getElementById('startButton');
    const startMenu = document.getElementById('startMenu');
    const startApps = document.getElementById('startApps');
    const selectionBox = document.getElementById('selectionBox');
    const desktopMenu = document.getElementById('desktopMenu');
    const toast = document.getElementById('toast');
    const clock = document.getElementById('clock');
    const winTemplate = document.getElementById('windowTemplate');

    const ICONS = {
      user: 'https://img.icons8.com/color/48/user-male-circle--v1.png',
      skills: 'https://img.icons8.com/color/48/source-code.png',
      exp: 'https://img.icons8.com/color/48/briefcase--v1.png',
      contact: 'https://img.icons8.com/color/48/new-post.png',
      resume: 'https://img.icons8.com/color/48/resume.png',
      github: 'https://img.icons8.com/fluency/48/github.png',
      pocket: 'https://img.icons8.com/fluency/48/smartphone-tablet.png',
      arena: 'https://img.icons8.com/color/48/controller.png',
      app: 'https://img.icons8.com/color/48/windows-xp.png'
    };

    const apps = {
      about: {
        title: 'Meu Perfil - Kauan', icon: ICONS.user, width: 650, height: 430,
        content: `
          <div class="window-section"><h3>Erick Kauan dos Santos Pereira Lauer</h3><p>Profissional de TI em Curitiba - PR, focado em estabilidade operacional, suporte técnico avançado e melhoria contínua de processos.</p></div>
          <div class="window-section"><h3>Posição Atual</h3><p><strong>Técnico de Suporte de TI • Headsoft Desenvolvimento de Sistemas</strong></p><p>Atuação com SQL Server, VS Code, Headcargo, 3CX, redes, hardware e atendimento técnico de alta demanda.</p></div>
          <div class="window-section"><h3>Formação</h3><p>Análise e Desenvolvimento de Sistemas - UniEnsino (concluído em Agosto/2025).</p></div>
          <div class="status-bar"><span>Status do sistema: Operacional</span><span>KauanWin v2.0</span></div>
        `,
      },
      skills: {
        title: 'Competências Técnicas', icon: ICONS.skills, width: 640, height: 460,
        content: `
          <div class="window-section"><h3>Stack Principal</h3><div class="skills-grid"><div class="skill-pill">SQL Server</div><div class="skill-pill">3CX / Teams</div><div class="skill-pill">Headcargo</div><div class="skill-pill">VS Code</div><div class="skill-pill">HTML/CSS/JavaScript</div><div class="skill-pill">Suporte e Helpdesk</div><div class="skill-pill">Configuração de Redes</div><div class="skill-pill">Formatação e Hardware</div></div></div>
          <div class="window-section"><h3>Diferencial</h3><p>Combino suporte operacional com lógica de automação, reduzindo retrabalho e aumentando previsibilidade técnica.</p></div>
          <div class="status-bar"><span>Drivers: OK</span><span>Performance: Alta</span></div>
        `,
      },
      experience: {
        title: 'Experiência Profissional', icon: ICONS.exp, width: 680, height: 470,
        content: `
          <div class="window-section"><h3>Técnico de Suporte de TI</h3><p><strong>Headsoft Desenvolvimento de Sistemas</strong> • Curitiba, PR • Out/2025 - Atual</p><ul><li>Suporte técnico avançado com SQL Server e VS Code.</li><li>Gestão de comunicação via Teams e telefonia 3CX.</li><li>Manutenção de hardware, formatação e padronização de máquinas.</li><li>Suporte ao Headcargo e implementação de automações.</li></ul></div>
          <div class="window-section"><h3>Analista Logístico</h3><p><strong>MANUPACKAGING FITASA DO BRASIL SA</strong> • Curitiba, PR • Ago/2021 - Out/2025</p><ul><li>Análise de dados com Excel VBA e SAP.</li><li>Automações para melhoria de processo em produção/logística.</li></ul></div>
          <div class="status-bar"><span>Histórico carregado</span><span>2 posições registradas</span></div>
        `,
      },
      contact: {
        title: 'Contato Direto', icon: ICONS.contact, width: 580, height: 380,
        content: `
          <div class="window-section"><h3>Vamos Conversar</h3><ul><li>Email: <a href="mailto:erickkauanlauer@gmail.com">erickkauanlauer@gmail.com</a></li><li>LinkedIn: <a href="https://linkedin.com/in/kauanlauer" target="_blank" rel="noopener">linkedin.com/in/kauanlauer</a></li><li>GitHub: <a href="https://github.com/kauanlauer" target="_blank" rel="noopener">github.com/kauanlauer</a></li><li>WhatsApp: <a href="https://api.whatsapp.com/send?phone=5541999426605" target="_blank" rel="noopener">(41) 99942-6605</a></li></ul></div>
          <div class="window-section"><h3>Disponibilidade</h3><p>Aberto para oportunidades em suporte, infraestrutura e operações técnicas.</p></div>
          <div class="status-bar"><span>Conectado à rede</span><span>Canal de contato ativo</span></div>
        `,
      },
      resume: {
        title: 'Currículo (Web)', icon: ICONS.resume, width: 780, height: 520,
        content: `
          <div class="window-section"><h3>Currículo Online</h3><p>Abra a versão oficial do currículo para download e visualização completa:</p><p><a href="https://kauanlauer.com.br/curriculo" target="_blank" rel="noopener">https://kauanlauer.com.br/curriculo</a></p></div>
          <div class="window-section"><iframe src="https://kauanlauer.com.br/curriculo" style="width:100%;height:320px;border:1px solid #9eb2d4;border-radius:4px;background:#fff;"></iframe></div>
          <div class="status-bar"><span>Fonte externa carregada</span><span>WebView ativo</span></div>
        `,
      },
      arena: {
        title: 'SOC Arena - Simulador', icon: ICONS.arena, width: 700, height: 470,
        content: `
          <div class="window-section"><h3>KauanWin Defense Arena</h3><p>Modo gamer técnico: análise de incidente e tomada de decisão rápida.</p></div>
          <div class="window-section"><img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExYTYweWg1bGNzY2RtZXN2NXB6eGQxM2p4MXRjM3VqM2I2YW5lMWY3eSZlcD12MV9naWZzX3NlYXJjaCZjdD1n/xT9IgzoKnwFNmISR8I/giphy.gif" alt="SOC GIF" style="width:100%;height:220px;object-fit:cover;border:1px solid #9eb2d4;border-radius:4px;"></div>
          <div class="status-bar"><span>Modo Arena ativo</span><span>Latência: 12ms</span></div>
        `,
      },
      github: {
        title: 'GitHub - Repositórios', icon: ICONS.github, width: 600, height: 300,
        content: `
          <div class="window-section"><h3>GitHub</h3><p>Acesse meus repositórios públicos:</p><p><a href="https://github.com/kauanlauer" target="_blank" rel="noopener">github.com/kauanlauer</a></p></div>
          <div class="status-bar"><span>Conexão segura (HTTPS)</span><span>Repositórios online</span></div>
        `,
      },
      pocket: {
        title: 'Kauan Pocket OS', icon: ICONS.pocket, width: 620, height: 340,
        content: `
          <div class="window-section"><h3>Versão Mobile do Portfólio</h3><p>Experiência estilo sistema operacional mobile com apps, notificações e navegação touch-first.</p><p><a href="KauanPocketOS.html">Abrir KauanPocketOS.html</a></p></div>
          <div class="window-section"><p>Também disponível em nova guia:</p><p><a href="KauanPocketOS.html" target="_blank" rel="noopener">Abrir Pocket OS em nova guia</a></p></div>
          <div class="status-bar"><span>KauanWin -> Pocket OS</span><span>Cross-platform ativo</span></div>
        `,
      },
      portfolio: {
        title: 'Portfólio Web (Normal)', icon: ICONS.app, width: 640, height: 350,
        content: `
          <div class="window-section"><h3>Voltar ao Portfólio Normal</h3><p>Se quiser sair do modo KauanWin e ver o portfólio clássico, use o botão abaixo.</p><p><a href="index.html">Abrir index.html</a></p></div>
          <div class="window-section"><p>Também disponível em nova guia:</p><p><a href="index.html" target="_blank" rel="noopener">Abrir em nova guia</a></p></div>
          <div class="status-bar"><span>Navegação local</span><span>KauanWin -> Portfólio</span></div>
        `,
      },
    };

    const desktopShortcuts = [
      { app: 'about', label: 'Meu Perfil' },
      { app: 'skills', label: 'Competências' },
      { app: 'experience', label: 'Experiência' },
      { app: 'contact', label: 'Contato' },
      { app: 'resume', label: 'Currículo' },
      { app: 'arena', label: 'SOC Arena' },
      { app: 'pocket', label: 'Pocket OS' },
      { app: 'github', label: 'GitHub' },
      { app: 'portfolio', label: 'Portfólio Web' },
    ];

    const openWindows = new Map();
    let zCounter = 12;
    let activeIcon = null;

    function showToast(message) {
      toast.textContent = message;
      toast.classList.remove('show');
      void toast.offsetWidth;
      toast.classList.add('show');
    }

    function clearIconSelection() {
      document.querySelectorAll('.desktop-icon').forEach((el) => el.classList.remove('selected'));
      activeIcon = null;
    }

    function gridCellToXY(col, row) {
      const gx = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-x'));
      const gy = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-y'));
      const px = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--desk-padding-x'));
      const py = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--desk-padding-y'));
      return { x: px + col * gx, y: py + row * gy };
    }

    function xyToNearestGrid(x, y) {
      const gx = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-x'));
      const gy = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-y'));
      const px = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--desk-padding-x'));
      const py = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--desk-padding-y'));
      const col = Math.max(0, Math.round((x - px) / gx));
      const row = Math.max(0, Math.round((y - py) / gy));
      return gridCellToXY(col, row);
    }

    function placeIcon(icon, x, y) {
      const maxX = desktop.clientWidth - icon.offsetWidth - 2;
      const maxY = desktop.clientHeight - icon.offsetHeight - 2;
      const nx = Math.max(0, Math.min(maxX, x));
      const ny = Math.max(0, Math.min(maxY, y));
      icon.style.left = nx + 'px';
      icon.style.top = ny + 'px';
    }

    function animateIconTo(icon, targetX, targetY, withPhysics = true) {
      if (!withPhysics) return placeIcon(icon, targetX, targetY);
      let vx = (targetX - parseFloat(icon.style.left || 0)) * 0.16;
      let vy = (targetY - parseFloat(icon.style.top || 0)) * 0.16;
      let x = parseFloat(icon.style.left || 0);
      let y = parseFloat(icon.style.top || 0);

      function step() {
        vx *= 0.82;
        vy *= 0.82;
        x += vx + (targetX - x) * 0.12;
        y += vy + (targetY - y) * 0.12;
        placeIcon(icon, x, y);
        const done = Math.abs(targetX - x) < 0.8 && Math.abs(targetY - y) < 0.8;
        if (!done) requestAnimationFrame(step);
        else placeIcon(icon, targetX, targetY);
      }
      requestAnimationFrame(step);
    }

    function makeDesktopIconDraggable(icon) {
      let dragging = false;
      let moved = false;
      let startX = 0;
      let startY = 0;
      let iconStartX = 0;
      let iconStartY = 0;
      let lastMouseX = 0;
      let lastMouseY = 0;
      let vx = 0;
      let vy = 0;
      let lastTs = 0;

      icon.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return;
        dragging = true;
        moved = false;
        icon.classList.add('dragging');
        startX = e.clientX;
        startY = e.clientY;
        iconStartX = parseFloat(icon.style.left || 0);
        iconStartY = parseFloat(icon.style.top || 0);
        lastMouseX = e.clientX;
        lastMouseY = e.clientY;
        lastTs = performance.now();
        clearIconSelection();
        icon.classList.add('selected');
        activeIcon = icon;
        e.preventDefault();
      });

      window.addEventListener('mousemove', (e) => {
        if (!dragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        if (Math.abs(dx) > 2 || Math.abs(dy) > 2) moved = true;
        placeIcon(icon, iconStartX + dx, iconStartY + dy);

        const now = performance.now();
        const dt = Math.max(1, now - lastTs);
        vx = (e.clientX - lastMouseX) / dt * 12;
        vy = (e.clientY - lastMouseY) / dt * 12;
        lastMouseX = e.clientX;
        lastMouseY = e.clientY;
        lastTs = now;
      });

      window.addEventListener('mouseup', () => {
        if (!dragging) return;
        dragging = false;
        icon.classList.remove('dragging');

        const currentX = parseFloat(icon.style.left || 0);
        const currentY = parseFloat(icon.style.top || 0);
        const inertialX = currentX + vx * 8;
        const inertialY = currentY + vy * 8;
        const snap = xyToNearestGrid(inertialX, inertialY);
        animateIconTo(icon, snap.x, snap.y, true);

        if (!moved) {
          // clique simples já tratado no click
        }
      });

      let clickTimer = null;
      icon.addEventListener('click', (e) => {
        e.stopPropagation();
        clearIconSelection();
        icon.classList.add('selected');
        activeIcon = icon;

        if (clickTimer) {
          clearTimeout(clickTimer);
          clickTimer = null;
          openApp(icon.dataset.app);
        } else {
          clickTimer = setTimeout(() => { clickTimer = null; }, 250);
        }
      });
    }

    function createDesktopIcon(item, index) {
      const app = apps[item.app];
      const icon = document.createElement('button');
      icon.type = 'button';
      icon.className = 'desktop-icon';
      icon.dataset.app = item.app;
      icon.innerHTML = `<img src="${app.icon}" alt="${item.label}"><span>${item.label}</span>`;

      const col = Math.floor(index / 6);
      const row = index % 6;
      const pos = gridCellToXY(col, row);
      placeIcon(icon, pos.x, pos.y);
      makeDesktopIconDraggable(icon);
      desktopIcons.appendChild(icon);
    }

    function makeTaskButton(appId, title, iconUrl) {
      const btn = document.createElement('button');
      btn.className = 'task-btn';
      btn.dataset.app = appId;
      btn.innerHTML = `<img src="${iconUrl}" alt=""> <span>${title}</span>`;
      btn.addEventListener('click', () => toggleFromTaskbar(appId));
      taskButtons.appendChild(btn);
      return btn;
    }

    function setActiveWindow(appId) {
      openWindows.forEach((data, id) => {
        const active = id === appId;
        data.window.classList.toggle('inactive', !active);
        data.task.classList.toggle('active', active && !data.minimized);
      });
    }

    function bringToFront(appId) {
      const data = openWindows.get(appId);
      if (!data) return;
      zCounter += 1;
      data.window.style.zIndex = zCounter;
      data.minimized = false;
      data.window.style.display = 'block';
      data.window.classList.add('restoring');
      setTimeout(() => data.window.classList.remove('restoring'), 180);
      setActiveWindow(appId);
    }

    function closeWindow(appId) {
      const data = openWindows.get(appId);
      if (!data) return;
      data.window.remove();
      data.task.remove();
      openWindows.delete(appId);
      const last = Array.from(openWindows.keys()).pop();
      if (last) bringToFront(last);
    }

    function minimizeWindow(appId) {
      const data = openWindows.get(appId);
      if (!data || data.minimized) return;
      data.minimized = true;
      data.window.classList.add('minimizing');
      setTimeout(() => {
        data.window.style.display = 'none';
        data.window.classList.remove('minimizing');
      }, 160);
      data.task.classList.remove('active');
      const lastVisible = Array.from(openWindows.entries()).findLast(([, d]) => !d.minimized);
      if (lastVisible) setActiveWindow(lastVisible[0]);
    }

    function toggleMaximize(appId) {
      const data = openWindows.get(appId);
      if (!data) return;
      const win = data.window;
      if (!win.classList.contains('maximized')) {
        data.restore = { top: win.style.top, left: win.style.left, width: win.style.width, height: win.style.height };
        win.classList.add('maximized');
      } else {
        win.classList.remove('maximized');
        if (data.restore) {
          win.style.top = data.restore.top;
          win.style.left = data.restore.left;
          win.style.width = data.restore.width;
          win.style.height = data.restore.height;
        }
      }
      bringToFront(appId);
    }

    function snapWindow(win, appId) {
      const rect = win.getBoundingClientRect();
      const margin = 18;
      const desktopH = window.innerHeight - 32;
      if (rect.top <= margin) {
        toggleMaximize(appId);
        return;
      }

      if (rect.left <= margin) {
        win.classList.remove('maximized');
        win.style.top = '0px';
        win.style.left = '0px';
        win.style.width = Math.floor(window.innerWidth / 2) + 'px';
        win.style.height = desktopH + 'px';
        return;
      }

      if (rect.right >= window.innerWidth - margin) {
        win.classList.remove('maximized');
        win.style.top = '0px';
        win.style.left = Math.floor(window.innerWidth / 2) + 'px';
        win.style.width = Math.ceil(window.innerWidth / 2) + 'px';
        win.style.height = desktopH + 'px';
      }
    }

    function toggleFromTaskbar(appId) {
      const data = openWindows.get(appId);
      if (!data) return;
      if (!data.minimized && !data.window.classList.contains('inactive')) minimizeWindow(appId);
      else bringToFront(appId);
    }

    function makeDraggable(win, handle, appId) {
      let dragging = false;
      let offsetX = 0;
      let offsetY = 0;
      let lastX = 0;
      let lastY = 0;
      let vx = 0;
      let vy = 0;
      let lastTs = 0;

      handle.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return;
        if (win.classList.contains('maximized')) return;
        dragging = true;
        bringToFront(appId);
        const rect = win.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        lastX = e.clientX;
        lastY = e.clientY;
        lastTs = performance.now();
        e.preventDefault();
      });

      window.addEventListener('mousemove', (e) => {
        if (!dragging) return;
        const maxX = window.innerWidth - win.offsetWidth;
        const maxY = window.innerHeight - 32 - win.offsetHeight;
        const left = Math.max(0, Math.min(maxX, e.clientX - offsetX));
        const top = Math.max(0, Math.min(maxY, e.clientY - offsetY));
        win.style.left = left + 'px';
        win.style.top = top + 'px';

        const now = performance.now();
        const dt = Math.max(1, now - lastTs);
        vx = (e.clientX - lastX) / dt * 14;
        vy = (e.clientY - lastY) / dt * 14;
        lastX = e.clientX;
        lastY = e.clientY;
        lastTs = now;
      });

      window.addEventListener('mouseup', () => {
        if (!dragging) return;
        dragging = false;

        let x = parseFloat(win.style.left || 0);
        let y = parseFloat(win.style.top || 0);
        const maxX = window.innerWidth - win.offsetWidth;
        const maxY = window.innerHeight - 32 - win.offsetHeight;
        let frames = 0;

        function inertia() {
          frames += 1;
          vx *= 0.86;
          vy *= 0.86;
          x += vx;
          y += vy;
          x = Math.max(0, Math.min(maxX, x));
          y = Math.max(0, Math.min(maxY, y));
          win.style.left = x + 'px';
          win.style.top = y + 'px';

          if (frames < 22 && (Math.abs(vx) > 0.5 || Math.abs(vy) > 0.5)) {
            requestAnimationFrame(inertia);
          } else {
            snapWindow(win, appId);
          }
        }

        requestAnimationFrame(inertia);
      });
    }

    function openApp(appId) {
      const app = apps[appId];
      if (!app) return;
      if (openWindows.has(appId)) return bringToFront(appId);

      const frag = winTemplate.content.cloneNode(true);
      const win = frag.querySelector('.xp-window');
      const titlebar = frag.querySelector('.titlebar');
      const titleIcon = frag.querySelector('.title-info img');
      const titleText = frag.querySelector('.title-info span');
      const body = frag.querySelector('.window-body');

      titleIcon.src = app.icon;
      titleText.textContent = app.title;
      body.innerHTML = app.content;

      win.style.width = (app.width || 620) + 'px';
      win.style.height = (app.height || 420) + 'px';
      win.style.top = (48 + Math.random() * 70) + 'px';
      win.style.left = (120 + Math.random() * 140) + 'px';
      win.style.zIndex = ++zCounter;

      frag.querySelector('.win-btn.close').addEventListener('click', () => closeWindow(appId));
      frag.querySelector('.win-btn.min').addEventListener('click', () => minimizeWindow(appId));
      frag.querySelector('.win-btn.max').addEventListener('click', () => toggleMaximize(appId));

      win.addEventListener('mousedown', () => bringToFront(appId));
      titlebar.addEventListener('dblclick', () => toggleMaximize(appId));

      makeDraggable(win, titlebar, appId);
      windowLayer.appendChild(win);

      const task = makeTaskButton(appId, app.title, app.icon);
      openWindows.set(appId, { window: win, task, minimized: false, restore: null });
      setActiveWindow(appId);

      closeContextMenus();
      startMenu.classList.remove('open');
    }

    function closeContextMenus() { desktopMenu.classList.remove('open'); }

    function arrangeIcons() {
      const icons = Array.from(desktopIcons.children).sort((a, b) => a.dataset.app.localeCompare(b.dataset.app));
      icons.forEach((icon, idx) => {
        const col = Math.floor(idx / 6);
        const row = idx % 6;
        const pos = gridCellToXY(col, row);
        animateIconTo(icon, pos.x, pos.y, true);
      });
      showToast('Ícones organizados por nome.');
    }

    function refreshDesktop() {
      desktopIcons.style.opacity = '0.45';
      setTimeout(() => desktopIcons.style.opacity = '1', 180);
      showToast('KauanWin foi atualizado.');
    }

    startButton.addEventListener('click', (e) => {
      e.stopPropagation();
      startMenu.classList.toggle('open');
      closeContextMenus();
    });

    startMenu.addEventListener('click', (e) => {
      const appBtn = e.target.closest('[data-action]');
      if (!appBtn) return;
      openApp(appBtn.dataset.action);
    });

    desktop.addEventListener('click', (e) => {
      if (!e.target.closest('.desktop-icon') && !e.target.closest('.xp-window') && !e.target.closest('.start-menu')) clearIconSelection();
      closeContextMenus();
      if (!e.target.closest('.start-menu') && !e.target.closest('.start-button')) startMenu.classList.remove('open');
    });

    desktop.addEventListener('contextmenu', (e) => {
      if (e.target.closest('.xp-window')) return;
      e.preventDefault();
      startMenu.classList.remove('open');
      desktopMenu.classList.add('open');
      desktopMenu.style.left = `${Math.min(e.clientX, window.innerWidth - 210)}px`;
      desktopMenu.style.top = `${Math.min(e.clientY, window.innerHeight - 190)}px`;
    });

    desktopMenu.addEventListener('click', (e) => {
      const cmdBtn = e.target.closest('button[data-cmd]');
      if (!cmdBtn) return;
      const cmd = cmdBtn.dataset.cmd;
      if (cmd === 'refresh') refreshDesktop();
      if (cmd === 'arrange') arrangeIcons();
      if (cmd === 'about') showToast('KauanWin XP - Portfólio interativo do Kauan.');
      if (cmd === 'properties') openApp('about');
      closeContextMenus();
    });

    let selecting = false;
    let startX = 0;
    let startY = 0;

    desktop.addEventListener('mousedown', (e) => {
      if (e.button !== 0) return;
      if (e.target.closest('.desktop-icon') || e.target.closest('.xp-window') || e.target.closest('.taskbar') || e.target.closest('.start-menu')) return;
      selecting = true;
      startX = e.clientX;
      startY = e.clientY;
      selectionBox.style.display = 'block';
      selectionBox.style.left = `${startX}px`;
      selectionBox.style.top = `${startY}px`;
      selectionBox.style.width = '0px';
      selectionBox.style.height = '0px';
      clearIconSelection();
    });

    window.addEventListener('mousemove', (e) => {
      if (!selecting) return;
      const x = Math.min(e.clientX, startX);
      const y = Math.min(e.clientY, startY);
      const w = Math.abs(e.clientX - startX);
      const h = Math.abs(e.clientY - startY);
      selectionBox.style.left = `${x}px`;
      selectionBox.style.top = `${y}px`;
      selectionBox.style.width = `${w}px`;
      selectionBox.style.height = `${h}px`;

      const selRect = selectionBox.getBoundingClientRect();
      document.querySelectorAll('.desktop-icon').forEach((icon) => {
        const r = icon.getBoundingClientRect();
        const intersects = !(selRect.right < r.left || selRect.left > r.right || selRect.bottom < r.top || selRect.top > r.bottom);
        icon.classList.toggle('selected', intersects);
      });
    });

    window.addEventListener('mouseup', () => {
      if (selecting) {
        selecting = false;
        selectionBox.style.display = 'none';
      }
    });

    function updateClock() {
      const d = new Date();
      const hh = String(d.getHours()).padStart(2, '0');
      const mm = String(d.getMinutes()).padStart(2, '0');
      clock.textContent = `${hh}:${mm}`;
    }

    setInterval(updateClock, 1000);
    updateClock();

    desktopShortcuts.forEach((item, idx) => createDesktopIcon(item, idx));

    [
      { app: 'about', label: 'Meu Perfil', icon: ICONS.user },
      { app: 'skills', label: 'Competências', icon: ICONS.skills },
      { app: 'experience', label: 'Experiência', icon: ICONS.exp },
      { app: 'contact', label: 'Contato', icon: ICONS.contact },
      { app: 'arena', label: 'SOC Arena', icon: ICONS.arena },
      { app: 'pocket', label: 'Pocket OS', icon: ICONS.pocket },
      { app: 'github', label: 'GitHub', icon: ICONS.github },
      { app: 'portfolio', label: 'Portfólio Web', icon: ICONS.app },
    ].forEach((item) => {
      const btn = document.createElement('button');
      btn.className = 'start-item';
      btn.dataset.action = item.app;
      btn.innerHTML = `<img src="${item.icon}" alt=""> <span>${item.label}</span>`;
      startApps.appendChild(btn);
    });

    // KauanWin inicia com desktop limpo, sem janelas abertas.
  </script>
</body>
</html>
